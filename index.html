<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC P2P Test (with TURN)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        textarea { font-family: monospace; font-size: 0.875rem; line-height: 1.25rem; word-break: break-all; }
        textarea:disabled, button:disabled { opacity: 0.5; cursor: not-allowed; }
        .role-disabled { filter: grayscale(80%); opacity: 0.6; pointer-events: none; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex items-center justify-center font-sans p-4">

    <div class="container mx-auto max-w-4xl w-full bg-gray-800 rounded-lg shadow-xl p-6">
        <h1 class="text-3xl font-bold text-center text-indigo-400 mb-6">WebRTC Peer-to-Peer Test</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div class="bg-gray-700 p-4 rounded-lg">
                <h2 class="text-xl font-semibold mb-2 text-center">Local Stream</h2>
                <video id="localVideo" playsinline autoplay muted class="w-full h-auto bg-black rounded-md aspect-video"></video>
            </div>
            <div class="bg-gray-700 p-4 rounded-lg">
                <h2 class="text-xl font-semibold mb-2 text-center">Remote Stream</h2>
                <video id="remoteVideo" playsinline autoplay class="w-full h-auto bg-black rounded-md aspect-video"></video>
            </div>
        </div>

        <div class="text-center mb-6">
            <button id="startButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-200 shadow-md">
                1. Start Camera
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
            <!-- Left Side: Offerer -->
            <div id="offerer-panel" class="space-y-4">
                <div class="bg-gray-700 p-4 rounded-lg">
                    <button id="createOfferButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 mb-2" disabled>
                        2. Create Offer
                    </button>
                    <textarea id="offerSDP" rows="6" class="w-full p-2 bg-gray-900 text-gray-300 rounded-md border border-gray-600" placeholder="Click 'Create Offer' to generate..." readonly></textarea>
                </div>
                <div class="bg-gray-700 p-4 rounded-lg">
                    <textarea id="answerSDP" rows="6" class="w-full p-2 bg-gray-900 text-gray-300 rounded-md border border-gray-600" placeholder="Paste the 'Answer' from the other device here..."></textarea>
                    <button id="connectButton" class="w-full mt-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200" disabled>
                        5. Connect
                    </button>
                </div>
            </div>

            <!-- Right Side: Answerer -->
            <div id="answerer-panel" class="space-y-4">
                <div class="bg-gray-700 p-4 rounded-lg">
                    <textarea id="offerToReceive" rows="6" class="w-full p-2 bg-gray-900 text-gray-300 rounded-md border border-gray-600" placeholder="Paste the 'Offer' from the other device here..."></textarea>
                    <button id="createAnswerButton" class="w-full mt-2 bg-yellow-600 hover:bg-yellow-700 text-black font-bold py-2 px-4 rounded-lg transition duration-200" disabled>
                        3. Create Answer
                    </button>
                </div>
                <div class="bg-gray-700 p-4 rounded-lg">
                    <h3 class="font-semibold mb-2">4. Your Answer:</h3>
                    <textarea id="answerToShare" rows="6" class="w-full p-2 bg-gray-900 text-gray-300 rounded-md border border-gray-600" placeholder="Your 'Answer' will appear here to copy..." readonly></textarea>
                </div>
            </div>
        </div>
        
        <div id="statusMessage" class="text-center text-yellow-400 font-medium mt-4 h-6"></div>
    </div>

    <script>
        const startButton = document.getElementById('startButton');
        const createOfferButton = document.getElementById('createOfferButton');
        const createAnswerButton = document.getElementById('createAnswerButton');
        const connectButton = document.getElementById('connectButton');
        
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        
        const offerSDP = document.getElementById('offerSDP');
        const answerSDP = document.getElementById('answerSDP');
        const offerToReceive = document.getElementById('offerToReceive');
        const answerToShare = document.getElementById('answerToShare');
        const statusMessage = document.getElementById('statusMessage');

        const offererPanel = document.getElementById('offerer-panel');
        const answererPanel = document.getElementById('answerer-panel');

        let localStream;
        let pc; // PeerConnection

        // ======================================================================
        // --- START: CODE UPDATED WITH TURN SERVER ---
        // ======================================================================
        const configuration = { 
            iceServers: [
                // Plan A: Try to connect directly using a STUN server
                { urls: 'stun:stun.l.google.com:19302' },

                // Plan B: If STUN fails, use this TURN server as a fallback relay
                {
                    urls: 'turn:relay1.expressturn.com:3480',
                    username: '000000002076492763',
                    credential: 'c0gF9hE/qvrhetCJUVOMWrvbUa8=' // Note: The API uses 'credential', not 'password'
                }
            ] 
        };
        // ======================================================================
        // --- END: CODE UPDATED ---
        // ======================================================================

        startButton.onclick = startCamera;
        createOfferButton.onclick = createOffer;
        createAnswerButton.onclick = createAnswer;
        connectButton.onclick = connectPeers;
        
        offerToReceive.oninput = () => createAnswerButton.disabled = !localStream || !offerToReceive.value;
        answerSDP.oninput = () => connectButton.disabled = !pc || !answerSDP.value;

        async function startCamera() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = localStream;
                
                createOfferButton.disabled = false;
                createAnswerButton.disabled = false;
                
                startButton.disabled = true;
                startButton.innerText = "Camera Active";
                showStatus("Camera started. Choose a role: Offerer or Answerer.");
            } catch (err) {
                console.error('Error accessing media devices.', err);
                showStatus("Error: Could not access camera/mic. Check permissions.");
            }
        }

        async function createOffer() {
            showStatus("Creating offer...");
            answererPanel.classList.add('role-disabled');
            
            pc = new RTCPeerConnection(configuration);
            setupPeerConnectionEvents(pc);

            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

            const iceGatheringPromise = new Promise(resolve => {
                pc.onicecandidate = event => !event.candidate && resolve();
            });

            try {
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                
                showStatus("Gathering ICE candidates (incl. TURN)...");
                await iceGatheringPromise;
                
                offerSDP.value = JSON.stringify(pc.localDescription);
                showStatus("Offer created. Copy and send to the other peer.");
                createOfferButton.disabled = true;
            } catch (err) {
                console.error('Error creating offer.', err);
                showStatus("Error creating offer.");
            }
        }
        
        async function createAnswer() {
            showStatus("Creating answer...");
            offererPanel.classList.add('role-disabled');

            pc = new RTCPeerConnection(configuration);
            setupPeerConnectionEvents(pc);

            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
            
            const iceGatheringPromise = new Promise(resolve => {
                pc.onicecandidate = event => !event.candidate && resolve();
            });
            
            try {
                const offer = JSON.parse(offerToReceive.value);
                await pc.setRemoteDescription(new RTCSessionDescription(offer));
                
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                
                showStatus("Gathering ICE candidates (incl. TURN)...");
                await iceGatheringPromise;

                answerToShare.value = JSON.stringify(pc.localDescription);
                showStatus("Answer created. Copy and send back to the offerer.");
                createAnswerButton.disabled = true;
            } catch (err) {
                console.error('Error creating answer.', err);
                showStatus("Error creating answer. Is the offer valid?");
            }
        }

        async function connectPeers() {
            if (pc.signalingState !== 'have-local-offer') {
                return showStatus(`Error: Wrong state (${pc.signalingState}).`);
            }
            showStatus("Connecting...");
            try {
                const answer = JSON.parse(answerSDP.value);
                await pc.setRemoteDescription(new RTCSessionDescription(answer));
                connectButton.disabled = true;
            } catch (err) {
                console.error('Error setting remote description.', err);
                showStatus(`Error connecting: ${err.message}`);
            }
        }
        
        function setupPeerConnectionEvents(peerConnection) {
            peerConnection.ontrack = (event) => {
                showStatus("Receiving remote stream...");
                if (remoteVideo.srcObject !== event.streams[0]) {
                    remoteVideo.srcObject = event.streams[0];
                }
            };

            peerConnection.onconnectionstatechange = () => {
                showStatus(`Connection state: ${peerConnection.connectionState}`);
                if (peerConnection.connectionState === 'connected') {
                    showStatus("Peers connected!");
                }
            };

            peerConnection.onsignalingstatechange = () => {
                console.log(`Signaling state: ${peerConnection.signalingState}`);
            };
        }
        
        function showStatus(message) {
            console.log(message);
            statusMessage.innerText = message;
        }
    </script>
</body>
</html>